<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QBICE Dependency Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e; color: #eee; height: 100vh; overflow: hidden;
        }
        .container { display: flex; height: 100vh; }
        #cy { flex: 1; background: #16213e; }
        .sidebar {
            width: 350px; background: #0f3460; padding: 20px;
            overflow-y: auto; border-left: 2px solid #e94560;
        }
        h1 { font-size: 1.5rem; margin-bottom: 20px; color: #e94560; }
        h2 { font-size: 1.1rem; margin: 20px 0 10px; color: #e94560; }
        .stats {
            background: rgba(233, 69, 96, 0.1); padding: 15px;
            border-radius: 8px; margin-bottom: 20px;
        }
        .stat-item { display: flex; justify-content: space-between; padding: 5px 0; }
        .stat-value { color: #e94560; font-weight: bold; }
        .controls { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #aaa; }
        input[type="text"], select {
            width: 100%; padding: 10px; border: none; border-radius: 4px;
            background: #1a1a2e; color: #eee; margin-bottom: 10px;
        }
        input[type="text"]:focus, select:focus { outline: 2px solid #e94560; }
        button {
            padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;
            margin-right: 5px; margin-bottom: 5px; transition: all 0.2s;
        }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #ff6b6b; }
        .btn-secondary { background: #1a1a2e; color: #eee; }
        .btn-secondary:hover { background: #2a2a4e; }
        .node-details {
            background: #1a1a2e; padding: 15px; border-radius: 8px;
            margin-top: 20px; display: none;
        }
        .node-details.active { display: block; }
        .detail-label { color: #aaa; font-size: 0.8rem; text-transform: uppercase; margin-top: 10px; }
        .detail-value { color: #eee; word-break: break-all; padding: 5px 0; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        .badge-input { background: #4ecdc4; color: #1a1a2e; }
        .badge-computed { background: #6c5ce7; color: white; }
        .legend { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .legend-item { display: flex; align-items: center; margin: 8px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        .legend-input { background: #4ecdc4; }
        .legend-computed { background: #6c5ce7; }
        .legend-line { width: 30px; height: 3px; margin-right: 10px; }
        .legend-clean { background: #4ecdc4; }
        .legend-dirty { background: #e94560; background: repeating-linear-gradient(90deg, #e94560, #e94560 5px, transparent 5px, transparent 10px); height: 3px; }
        .legend-unknown { background: repeating-linear-gradient(90deg, #888, #888 3px, transparent 3px, transparent 6px); height: 3px; }
        .layout-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="cy"></div>
        <div class="sidebar">
            <h1>üîç QBICE Graph</h1>
            <div class="stats">
                <div class="stat-item"><span>Total Queries</span><span class="stat-value">11</span></div>
                <div class="stat-item"><span>Dependencies</span><span class="stat-value">10</span></div>
                <div class="stat-item"><span>Input Queries</span><span class="stat-value">5</span></div>
            </div>
            <div class="controls">
                <label for="search">Search Queries</label>
                <input type="text" id="search" placeholder="Type to search...">
                <label for="type-filter">Filter by Type</label>
                <select id="type-filter"><option value="">All Types</option><option value="UnknownType(0xC8502FDB3532F754F4A4613778E5A5FB)">UnknownType(0xC8502FDB3532F754F4A4613778E5A5FB) (1)</option><option value="UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0)">UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0) (4)</option><option value="projection::CollectDoubledSquareVariables">projection::CollectDoubledSquareVariables (1)</option><option value="projection::DoubleSquare">projection::DoubleSquare (1)</option><option value="projection::SlowSquare">projection::SlowSquare (4)</option></select>
            </div>
            <h2>Layout</h2>
            <div class="layout-buttons">
                <button class="btn-primary" onclick="applyLayout('dagre')">Hierarchical</button>
                <button class="btn-secondary" onclick="applyLayout('cose')">Force</button>
                <button class="btn-secondary" onclick="applyLayout('breadthfirst')">Breadthfirst</button>
                <button class="btn-secondary" onclick="applyLayout('circle')">Circle</button>
                <button class="btn-secondary" onclick="applyLayout('grid')">Grid</button>
            </div>
            <h2>Actions</h2>
            <button class="btn-primary" onclick="cy.fit()">Fit to View</button>
            <button class="btn-secondary" onclick="cy.reset()">Reset</button>
            <button class="btn-secondary" onclick="highlightInputs()">Show Inputs</button>
            <button class="btn-secondary" onclick="clearHighlights()">Clear Highlights</button>
            <div id="node-details" class="node-details">
                <h2>Selected Query</h2>
                <div class="detail-label">Type</div>
                <div class="detail-value" id="detail-type"></div>
                <div class="detail-label">Label</div>
                <div class="detail-value" id="detail-label"></div>
                <div class="detail-label">Result</div>
                <div class="detail-value" id="detail-result"></div>
                <div class="detail-label">Kind</div>
                <div class="detail-value" id="detail-kind"></div>
                <div class="detail-label">Dependencies (Callees)</div>
                <div class="detail-value" id="detail-deps"></div>
                <div class="detail-label">Dependents (Callers)</div>
                <div class="detail-value" id="detail-dependents"></div>
                <button class="btn-secondary" style="margin-top: 10px;" onclick="highlightDependencies()">Highlight Dependencies</button>
                <button class="btn-secondary" onclick="highlightDependents()">Highlight Dependents</button>
            </div>
            <div class="legend">
                <h2>Legend</h2>
                <div class="legend-item"><div class="legend-color legend-input"></div><span>Input Query</span></div>
                <div class="legend-item"><div class="legend-color legend-computed"></div><span>Computed Query</span></div>
                <h3 style="margin-top: 15px; font-size: 0.9rem; color: #e94560;">Edges</h3>
                <div class="legend-item"><div class="legend-line legend-clean"></div><span>Clean (validated)</span></div>
                <div class="legend-item"><div class="legend-line legend-dirty"></div><span>Dirty (needs revalidation)</span></div>
                <div class="legend-item"><div class="legend-line legend-unknown"></div><span>Unknown</span></div>
            </div>
        </div>
    </div>
    <script>
        const nodes = [{ data: { id: 'q_fcb20d12d8154192737e7d15a7131250_fe3e552e80f52c4102f4749fd103ede8', label: 'DoubleSquare(Variable(1))', typeName: 'projection::DoubleSquare', isInput: false, truncatedLabel: 'DoubleSquare(Variable(1))', result: 'Some(8)' }, classes: 'computed' },{ data: { id: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', label: 'CollectDoubledSquareVariables', typeName: 'projection::CollectDoubledSquareVariables', isInput: false, truncatedLabel: 'CollectDoubledSquareVariables', result: '{Variable(2): 18, Variable(3): 32, Variable(0): 2, Variable(1): 8}' }, classes: 'computed' },{ data: { id: 'q_c8502fdb3532f754f4a4613778e5a5fb_716d4466c5927c5f87cbbd3a05d97ba3', label: 'UnknownDigested(0x716D4466C5927C5F87CBBD3A05D97BA3)', typeName: 'UnknownType(0xC8502FDB3532F754F4A4613778E5A5FB)', isInput: true, truncatedLabel: 'UnknownDigested(0x716D4466C...', result: 'UnknownResult (please register the query for more information)' }, classes: 'input' },{ data: { id: 'q_0701d58c5eca5aec7151a7fda70911f2_408157adc357034a767b13b129d1f842', label: 'SlowSquare(Variable(0))', typeName: 'projection::SlowSquare', isInput: false, truncatedLabel: 'SlowSquare(Variable(0))', result: '1' }, classes: 'computed' },{ data: { id: 'q_0701d58c5eca5aec7151a7fda70911f2_b261df87c459478c156e01ae2ecb22f0', label: 'SlowSquare(Variable(2))', typeName: 'projection::SlowSquare', isInput: false, truncatedLabel: 'SlowSquare(Variable(2))', result: '9' }, classes: 'computed' },{ data: { id: 'q_0701d58c5eca5aec7151a7fda70911f2_fe3e552e80f52c4102f4749fd103ede8', label: 'SlowSquare(Variable(1))', typeName: 'projection::SlowSquare', isInput: false, truncatedLabel: 'SlowSquare(Variable(1))', result: '4' }, classes: 'computed' },{ data: { id: 'q_0701d58c5eca5aec7151a7fda70911f2_6065bcbb9d3cd8d2a2c9e1d4603ad29e', label: 'SlowSquare(Variable(3))', typeName: 'projection::SlowSquare', isInput: false, truncatedLabel: 'SlowSquare(Variable(3))', result: '16' }, classes: 'computed' },{ data: { id: 'q_d5506b726fea45d8671e3385a11fe2d0_408157adc357034a767b13b129d1f842', label: 'UnknownDigested(0x408157ADC357034A767B13B129D1F842)', typeName: 'UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0)', isInput: true, truncatedLabel: 'UnknownDigested(0x408157ADC...', result: 'UnknownResult (please register the query for more information)' }, classes: 'input' },{ data: { id: 'q_d5506b726fea45d8671e3385a11fe2d0_b261df87c459478c156e01ae2ecb22f0', label: 'UnknownDigested(0xB261DF87C459478C156E01AE2ECB22F0)', typeName: 'UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0)', isInput: true, truncatedLabel: 'UnknownDigested(0xB261DF87C...', result: 'UnknownResult (please register the query for more information)' }, classes: 'input' },{ data: { id: 'q_d5506b726fea45d8671e3385a11fe2d0_fe3e552e80f52c4102f4749fd103ede8', label: 'UnknownDigested(0xFE3E552E80F52C4102F4749FD103EDE8)', typeName: 'UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0)', isInput: true, truncatedLabel: 'UnknownDigested(0xFE3E552E8...', result: 'UnknownResult (please register the query for more information)' }, classes: 'input' },{ data: { id: 'q_d5506b726fea45d8671e3385a11fe2d0_6065bcbb9d3cd8d2a2c9e1d4603ad29e', label: 'UnknownDigested(0x6065BCBB9D3CD8D2A2C9E1D4603AD29E)', typeName: 'UnknownType(0xD5506B726FEA45D8671E3385A11FE2D0)', isInput: true, truncatedLabel: 'UnknownDigested(0x6065BCBB9...', result: 'UnknownResult (please register the query for more information)' }, classes: 'input' }];
        const edges = [{ data: { source: 'q_fcb20d12d8154192737e7d15a7131250_fe3e552e80f52c4102f4749fd103ede8', target: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3' }, classes: 'clean' },{ data: { source: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', target: 'q_c8502fdb3532f754f4a4613778e5a5fb_716d4466c5927c5f87cbbd3a05d97ba3' }, classes: 'clean' },{ data: { source: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', target: 'q_0701d58c5eca5aec7151a7fda70911f2_408157adc357034a767b13b129d1f842' }, classes: 'dirty' },{ data: { source: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', target: 'q_0701d58c5eca5aec7151a7fda70911f2_b261df87c459478c156e01ae2ecb22f0' }, classes: 'clean' },{ data: { source: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', target: 'q_0701d58c5eca5aec7151a7fda70911f2_fe3e552e80f52c4102f4749fd103ede8' }, classes: 'clean' },{ data: { source: 'q_6fabf60318f1a3048174dad4e720a140_716d4466c5927c5f87cbbd3a05d97ba3', target: 'q_0701d58c5eca5aec7151a7fda70911f2_6065bcbb9d3cd8d2a2c9e1d4603ad29e' }, classes: 'clean' },{ data: { source: 'q_0701d58c5eca5aec7151a7fda70911f2_408157adc357034a767b13b129d1f842', target: 'q_d5506b726fea45d8671e3385a11fe2d0_408157adc357034a767b13b129d1f842' }, classes: 'dirty' },{ data: { source: 'q_0701d58c5eca5aec7151a7fda70911f2_b261df87c459478c156e01ae2ecb22f0', target: 'q_d5506b726fea45d8671e3385a11fe2d0_b261df87c459478c156e01ae2ecb22f0' }, classes: 'clean' },{ data: { source: 'q_0701d58c5eca5aec7151a7fda70911f2_fe3e552e80f52c4102f4749fd103ede8', target: 'q_d5506b726fea45d8671e3385a11fe2d0_fe3e552e80f52c4102f4749fd103ede8' }, classes: 'clean' },{ data: { source: 'q_0701d58c5eca5aec7151a7fda70911f2_6065bcbb9d3cd8d2a2c9e1d4603ad29e', target: 'q_d5506b726fea45d8671e3385a11fe2d0_6065bcbb9d3cd8d2a2c9e1d4603ad29e' }, classes: 'clean' }];
        let selectedNode = null;
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: { nodes: nodes, edges: edges },
            style: [
                { selector: 'node', style: {
                    'label': 'data(truncatedLabel)', 'text-valign': 'center', 'text-halign': 'center',
                    'background-color': '#6c5ce7', 'color': '#fff', 'font-size': '10px',
                    'text-wrap': 'ellipsis', 'text-max-width': '100px', 'width': 'label', 'height': 'label',
                    'padding': '10px', 'shape': 'roundrectangle', 'border-width': 2, 'border-color': '#8b7ee7'
                } },
                { selector: 'node.input', style: { 'background-color': '#4ecdc4', 'border-color': '#6ee7de', 'shape': 'ellipse' } },
                { selector: 'edge', style: {
                    'width': 2, 'line-color': '#4ecdc4', 'target-arrow-color': '#4ecdc4',
                    'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'opacity': 0.7
                } },
                { selector: 'edge.clean', style: { 'line-color': '#4ecdc4', 'target-arrow-color': '#4ecdc4' } },
                { selector: 'edge.dirty', style: { 'line-color': '#e94560', 'target-arrow-color': '#e94560', 'line-style': 'dashed' } },
                { selector: 'edge.unknown', style: { 'line-color': '#888', 'target-arrow-color': '#888', 'line-style': 'dotted' } },
                { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#ff6b6b' } },
                { selector: 'node.highlighted', style: { 'background-color': '#ffd93d', 'border-color': '#ffec8b' } },
                { selector: 'node.dependency', style: { 'background-color': '#ff6b6b', 'border-color': '#ff8c8c' } },
                { selector: 'node.dependent', style: { 'background-color': '#4ecdc4', 'border-color': '#6ee7de' } },
                { selector: 'edge.highlighted', style: { 'line-color': '#ffd93d', 'target-arrow-color': '#ffd93d', 'width': 4, 'opacity': 1 } },
                { selector: 'node.faded', style: { 'opacity': 0.2 } },
                { selector: 'edge.faded', style: { 'opacity': 0.1 } }
            ],
            layout: { name: 'dagre', rankDir: 'TB', nodeSep: 50, rankSep: 80, animate: true, animationDuration: 500 },
            wheelSensitivity: 0.3
        });
        cy.on('tap', 'node', function(evt) { selectedNode = evt.target; showNodeDetails(selectedNode); });
        cy.on('tap', function(evt) { if (evt.target === cy) { hideNodeDetails(); selectedNode = null; } });
        function showNodeDetails(node) {
            const data = node.data();
            document.getElementById('detail-type').textContent = data.typeName;
            document.getElementById('detail-label').textContent = data.label;
            document.getElementById('detail-result').textContent = data.result || '(not computed)';
            document.getElementById('detail-kind').innerHTML = data.isInput
                ? '<span class="badge badge-input">Input</span>'
                : '<span class="badge badge-computed">Computed</span>';
            document.getElementById('detail-deps').textContent = node.outgoers('node').length;
            document.getElementById('detail-dependents').textContent = node.incomers('node').length;
            document.getElementById('node-details').classList.add('active');
        }
        function hideNodeDetails() { document.getElementById('node-details').classList.remove('active'); }
        function applyLayout(name) {
            let options = { name: name, animate: true, animationDuration: 500 };
            if (name === 'dagre') { options.rankDir = 'TB'; options.nodeSep = 50; options.rankSep = 80; }
            else if (name === 'cose') { options.nodeRepulsion = 400000; options.idealEdgeLength = 100; }
            else if (name === 'breadthfirst') { options.directed = true; options.spacingFactor = 1.5; }
            cy.layout(options).run();
        }
        function highlightDependencies() {
            if (!selectedNode) return;
            clearHighlights();
            const deps = selectedNode.successors();
            cy.elements().addClass('faded');
            selectedNode.removeClass('faded');
            deps.removeClass('faded');
            deps.nodes().addClass('dependency');
            deps.edges().addClass('highlighted');
        }
        function highlightDependents() {
            if (!selectedNode) return;
            clearHighlights();
            const dependents = selectedNode.predecessors();
            cy.elements().addClass('faded');
            selectedNode.removeClass('faded');
            dependents.removeClass('faded');
            dependents.nodes().addClass('dependent');
            dependents.edges().addClass('highlighted');
        }
        function highlightInputs() {
            clearHighlights();
            cy.elements().addClass('faded');
            cy.nodes('.input').removeClass('faded').addClass('highlighted');
        }
        function clearHighlights() { cy.elements().removeClass('faded highlighted dependency dependent'); }
        document.getElementById('search').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (!query) { clearHighlights(); return; }
            clearHighlights();
            cy.elements().addClass('faded');
            cy.nodes().forEach(function(node) {
                const label = node.data('label').toLowerCase();
                const typeName = node.data('typeName').toLowerCase();
                if (label.includes(query) || typeName.includes(query)) {
                    node.removeClass('faded').addClass('highlighted');
                }
            });
        });
        document.getElementById('type-filter').addEventListener('change', function(e) {
            const selectedType = e.target.value;
            if (!selectedType) { clearHighlights(); return; }
            clearHighlights();
            cy.elements().addClass('faded');
            cy.nodes().forEach(function(node) {
                if (node.data('typeName') === selectedType) {
                    node.removeClass('faded').addClass('highlighted');
                }
            });
        });
    </script>
</body>
</html>
